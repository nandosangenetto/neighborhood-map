function AppViewModel(){var e=this;e.places=ko.observableArray([]),e.search=ko.observable(""),e.message=ko.observable("Loading map"),e.isMapLoaded=ko.observable(!1),e.clickHandler=function(e){e.activate()},e.initiateSearch=function(){e.searchResult=ko.computed(function(){infoWindow.close(),e.places().forEach(function(a){a.name.toLowerCase().indexOf(e.search().toLowerCase())>=0?a.setVisible(!0):a.setVisible(!1)})})},e.getPlacesData=function(){e.message("Loading places"),fetch("data/data.json").then(function(e){return e.json()}).then(function(a){a.forEach(function(a){e.places.push(new Place(a))}),e.message("")}).catch(function(a){e.message("A problem occurred when loading the places")})},e.isMapLoaded.subscribe(function(a){a&&(e.getPlacesData(),e.initiateSearch())})}function Place(e){var a=this;a.id=e.id,a.lat=e.latitude,a.lng=e.longitude,a.location=new google.maps.LatLng({lat:a.lat,lng:a.lng}),a.name=e.name,a.address=e.address,a.website=e.website,a.visible=ko.observable(!0),a.marker=new google.maps.Marker({map:map,position:a.location}),a.setVisible=function(e){a.deactivate(),a.visible(e),a.marker.setVisible(e)},a.showWindow=function(){var e="<strong>"+a.name+"</strong><br>";e+=a.address,void 0!==a.website&&(e+='<br><br><a href="'+a.website+'" target="_blank">'+a.website+"</a>"),loading="<br><br>Loading contact informations...",a.getInfoFromFoursquare(e),infoWindow.setContent(e+loading),infoWindow.open(map,a.marker)},a.getInfoFromFoursquare=function(e){var t="https://api.foursquare.com/v2/venues/search";t+="?ll="+a.lat+","+a.lng,t+="&query="+a.name,t+="&client_id=IRY4XRFVZBIOBSJLKGYIOVJQLK3FN3VPPN0UMVRMVL2BA5RR",t+="&client_secret=X2ETPP3KI2QG3RYAEJBLCRGQ2P5NHHEF0QB40XX4BOBNUUVT",t+="&v=20170321",fetch(t).then(function(e){return e.json()}).then(function(a){if(0==a.response.venues.length)return void infoWindow.setContent(e);var t=a.response.venues[0].contact;e+="<br>",void 0!==t.formmattedPhone&&(e+="<br>Phone: "+t.formattedPhone),void 0!==t.twitter&&(e+='<br>Twitter: <a href="http://twitter.com/'+t.twitter+'" target="_blank">@'+t.twitter+"</a>"),void 0!==t.facebookUsername&&(e+='<br>Facebook: <a href="http://fb.com/'+t.facebookUsername+'" target="_blank">'+t.facebookUsername+"</a>"),e+='<br>Foursquare: <a href="https://foursquare.com/venue/'+a.response.venues[0].id+'" target="_blank">'+a.response.venues[0].name+"</a>",infoWindow.setContent(e)}).catch(function(a){app.message("An error occurred when loading info from Foursquare"),setTimeout(function(){app.message("")},3e3),infoWindow.setContent(e)})},a.activate=function(){a.showWindow(),a.marker.setAnimation(google.maps.Animation.BOUNCE),map.panTo(a.location),Place.prototype.active&&Place.prototype.active!==a&&Place.prototype.active.deactivate(),Place.prototype.active=a},a.deactivate=function(){a.marker.setAnimation(null),Place.prototype.active=null},a.openHandler=function(){Place.prototype.active!==a&&a.activate()},a.marker.addListener("click",a.openHandler)}function initMap(){function e(){var e={lat:map.getCenter().lat(),lng:map.getCenter().lng(),zoom:map.getZoom()};localStorage.setItem("state",JSON.stringify(e))}var a=localStorage.getItem("state"),t=null===a?{lat:-22.9020102,lng:-43.2562987,zoom:12}:JSON.parse(a);map=new google.maps.Map(document.getElementById("map"),{zoom:t.zoom,center:{lat:t.lat,lng:t.lng},disableDefaultUI:!0}),infoWindow=new google.maps.InfoWindow({maxWidth:250}),infoWindow.addListener("closeclick",function(){Place.prototype.active.deactivate()}),map.addListener("dragend",e),map.addListener("zoom_changed",e),ko.applyBindings(app),app.isMapLoaded(!0)}function errorMap(){ko.applyBindings(app),app.message("An error occurred when loading the map")}Place.prototype.active=null;var map,infoWindow,app=new AppViewModel;